# Generated by Django 5.2.7 on 2025-11-21 06:03

from django.db import migrations, models
import django.db.models.deletion


def ensure_departments_exist(apps, schema_editor):
    """
    Data migration: ƒê·∫£m b·∫£o c√≥ √≠t nh·∫•t 1 department tr∆∞·ªõc khi l√†m field required
    N·∫øu ch∆∞a c√≥ department n√†o, t·∫°o m·ªôt department m·∫∑c ƒë·ªãnh
    """
    Department = apps.get_model('appointments', 'Department')
    Appointment = apps.get_model('appointments', 'Appointment')
    
    # Ki·ªÉm tra xem c√≥ appointments n√†o v·ªõi department=None kh√¥ng
    appointments_without_dept = Appointment.objects.filter(department__isnull=True)
    
    if appointments_without_dept.exists():
        # N·∫øu c√≥ appointments kh√¥ng c√≥ department, c·∫ßn x·ª≠ l√Ω
        # Option 1: T·∫°o default department v√† assign
        default_dept, created = Department.objects.get_or_create(
            name='General',
            defaults={
                'icon': 'üè•',
                'description': 'General department for existing appointments',
                'is_active': True
            }
        )
        
        # Assign default department cho c√°c appointments kh√¥ng c√≥ department
        appointments_without_dept.update(department=default_dept)


class Migration(migrations.Migration):

    dependencies = [
        ('appointments', '0002_department_remove_service_icon_and_more'),
    ]

    operations = [
        # Data migration: ƒê·∫£m b·∫£o kh√¥ng c√≥ appointments n√†o v·ªõi department=None
        migrations.RunPython(ensure_departments_exist, migrations.RunPython.noop),
        
        # Alter field: L√†m department non-nullable
        migrations.AlterField(
            model_name='appointment',
            name='department',
            field=models.ForeignKey(
                help_text="Department/specialty that patient selected (e.g., 'Nhi khoa', 'Tim m·∫°ch')",
                on_delete=django.db.models.deletion.PROTECT,
                related_name='appointments',
                to='appointments.department'
            ),
        ),
    ]
