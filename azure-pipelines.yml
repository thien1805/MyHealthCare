trigger:
  branches:
    include:
      - main
      - develop
      - feature/*
  paths:
    exclude:
    - README.md
    - requirements.txt
    - pytest.ini
    - .env
    - .gitignore
    - .git

variables:
  pythonVersion: '3.11'
  azureWebAppName: 'myhealthcare-api'
  azureWebAppPackage: '$(System.DefaultWorkingDirectory)'

stages:
  stage: BuildAndTest
  displayName: 'Build and test'
  jobs:
    - job: Build
      displayName: 'Build Django app'
      pool:
        vmImage: 'ubuntu-latest'
      
      steps:
        - checkout: self
          displayName: 'Checkout code'
          fetchDepth: 1 #chỉ fetch 1 commit đeer tăng tốc

        - task: UsePythonVersion@0
          displayName: 'Setup Python $(pythonVersion)'
          inputs:
            versionSpec: '$(pythonVersion)'

        - task: Cache@2
          displayName: 'Cache pip packages'
          inputs:
            key: 'pip | requirements.txt'
            path: '$(Pipeline.Workspace)/.pip'
            cacheHitVar: 'PIP_CACHE_RESTORED'
        
        - script:
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          displayName: 'Install Python dependencies'
          workingDirectory: '$(System.DefaultWorkingDirectory)'

        - script: |
            pip install flake8 black
            echo "Running flake8..."
            flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
            echo "Code linting completed"
          displayName: 'Code Linting (Optional)'
          continueOnError: true  # Không fail pipeline nếu lint có lỗi
        
        - script: |
            python manage.py check --deploy
          displayName: 'Run Django checks'
          env: 
            DJANGO_SECRET_KEY: 'dummy-key-for-check'
            DJANGO_DEBUG: 'False'
            DJANGO_ALLOWED_HOSTS: 'localhost'
          
        - script: |
            pytest --cov=apps --cov-report=xml --cov-report=html --junitxml=junit/test-results.xml -v
          displayName: 'Run Tests with Coverage'
          env:
            DJANGO_SECRET_KEY: 'test-secret-key'
            DJANGO_DEBUG: 'True'
            DJANGO_ALLOWED_HOSTS: 'localhost'
            # Test database (SQLite in-memory cho CI)
            DATABASE_URL: 'sqlite:///:memory:'
            continueOnError: false

        - task: PublishTestResults@2
          displayName: 'Publish Test Results'
          inputs:
            testResultsFiles: 'junit/test-results.xml'
            testRunTitle: 'Django Test Results'
          condition: always()  # Luôn chạy dù test pass hay fail

        - task: PublishCodeCoverageResults@1
          displayName: 'Publish Code Coverage'
          inputs:
            codeCoverageTool: 'Cobertura'
            summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'
            reportDirectory: '$(System.DefaultWorkingDirectory)/htmlcov'
          condition: always()
        
        - task: PublishBuildArtifacts@1
          displayName: 'Publish Build Artifacts'
          inputs:
            PathToPublish: '$(System.DefaultWorkingDirectory)'
            ArtifactName: 'drop'
            publishLocation: 'Container'

    - stage: Deploy
      displayName: 'Deploy to Azure'
      dependsOn: BuildAndTest
      condition: succeeded()
      jobs:
        - deployment: DeployToAzure
          displayName: 'Deploy Django to Azure'
          environment: 'production'
          pool:
            vmImage: 'ubuntu-latest'
          
          strategy:
            runOnce:
              deploy:
                steps:
                - download: current
                  displayName: 'Download build artifacts'
                  artifact: 'drop'

                - task: AzureWebApp@1
                  displayName: 'Deploy Django to Azure'
                  inputs:
                    azureSubscription: 'azure-subscription' #tên subscription trong Azure
                    appName: '$(azureWebAppName)'
                    package: '$(azureWebAppPackage)'
                    runtimeStack: 'PYTHON|3.11'
                    startUpCommand: 'bash startup.sh'
                   
                - script: |
                    echo "Waiting for app to start..."
                    sleep 10
                    echo "Deployment completed successfully"
                  displayName: 'Verify Deployment'
          
            


                  

